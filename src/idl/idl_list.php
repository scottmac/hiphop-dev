<?php

$format = $argv[1];
$output = $argv[2];
($f = fopen($output, 'w')) || die("cannot open $output");

fwrite($f, "\n/* Generated by idl_list.php. Do NOT modify. */\n\n");

switch ($format) {
 case 'ext':
   fwrite($f, "#include <runtime/ext/crutch.h>\n");
   break;
}

exec('ls *.idl.php', $files);
foreach ($files as $file) {
  preg_match('/^(.*)\.idl\.php$/', $file, $matches);
  $name = $matches[1];
  $ucname = ucfirst($name);

  switch ($format) {
  case 'inc':
    fwrite($f, "#include \"$name.inc\"\n");
    break;
  case 'test_ext':
    fwrite($f, "#include <test/test_ext_$name.h>\n");
    break;
  case 'test_suites':
    fwrite($f, "RUN_TESTSUITE(TestExt$ucname);\n");
    break;
  case 'ext':
    fwrite($f, "#include <runtime/ext/profile/extprofile_$name.h>\n");
    break;
  }
}

fclose($f);
